# Case Study: NHANES

This case study follows the tutorial laid out in section 7.5 of @Heeringa2017. It uses the *National Health and Nutrition Examination Survey (NHANES)* to build a predictive model of diastolic blood pressure (DBP). The NHANES sample is a stratified cluster sample, weighted for unequal probabilities of selection, nonresponse, and post-stratification.

```{r setup, message=FALSE, warning=FALSE}
library(tidyverse)
library(scales)
library(janitor)
library(survey)
library(srvyr)
library(gtsummary)
```

## Executive summary

- Provide a brief overview of the survey including information related  to general study goals and year when annual survey was first implemented.
- Describe the purpose of this document.
- Provide a table of the sample size to be selected per business unit (i.e.,  respondent sample size inflated for ineligibility and nonresponse). 
- Discuss the contents of the remaining section of the report.  

## Sample design

**Description of the target population.** 

The target population was adults aged 18 and older residing in the 48 contiguous United States.

**Describe the sampling frame including the date and source database.** 

The sampling frame included households in the 48 contiguous United States. The survey was conducted between February 2001 and April 2003. The source database for the sampling frame was the Inter-university Consortium for Political and Social Research (ICPSR), which provided the necessary geographic and demographic information to ensure a nationally representative sample.

**Describe the type of sample and method of sample selection to be used.** 

The sampling strategy was a multi-stage clustered area probability sample. 
  - Stage 1 was to select primary sampling units. The entire country (48 contiguous states) was divided into primary sampling units (PSUs), composed of counties or groups of contiguous counties. A random sample of PSUs was selected.
  - Stage 2 was to select segments. The selected PSUs were subdivided into segments, usually census tracts or block groups. A random sample of segments was selected.
  - Stage 3 was to select households. A random sample of households was selected.
  - Stage 4 was to select respondents. A person was randomly selected from the household.

## Sample size and allocation

- Optimization requirements
  – Optimization details including constraints and budget.  
  – Detail the minimum domain sizes and mechanics used to determine  the sizes. 
- Optimization results  
  – Results: minimum respondent sample size per stratum  
  – Marginal sample sizes for key reporting domains  
  – Estimated precision achieved by optimization results  
- Inflation adjustments to allocation solution  
  – Nonresponse adjustments  
  – Adjustments for ineligible sample members  
- Final sample allocation  
  – Marginal sample sizes for key reporting domains  
- Sensitivity analysis  
  – Results from comparing deviations to allocation after introducing  changes to the optimization system  
  
## Data Preparation

I downloaded [2015SEP2017.zip](https://www.umich.edu/~surveymethod/asda/Chapter%20Exercises%20Data%20Sets%20Stata%2015SEP2017.zip) from the [book web site](https://websites.umich.edu/~surveymethod/asda/#Links%20to%20Data%20Sets%20for%20First%20and%20Second%20Editions) and unzipped into the input/ directory of this project repo.
 
```{r}
nhanes_raw <- foreign::read.dta("input/nhanes1112_sub_10jun2016.dta")
```

Heeringa identifies a data cleaning step, converting 0s to `NA`.

```{r}
nhanes <-
  nhanes_raw |>
  mutate(
    bpxdi1_1 = if_else(BPXDI1 == 0, NA_integer_, BPXDI1),
    RIDRETH1 = factor(RIDRETH1, labels = c(
      "Mexican-American", "Other Hispanic", "Non-Hispanic White",
      "Non-Hispanic Black", "Other race")),
    riagendr = factor(riagendr, labels = c("Male", "Female")),
    marcat = factor(marcat, labels = c(
      "Married", "Previously married", "Never married"))
  )
```

Define the survey design object.

```{r}
nhanes_des <- as_survey_design(
  nhanes,
  ids = sdmvpsu,  # primary sampling unit (cluster)
  strata = sdmvstra,  # sampling stratum
  nest = TRUE,  # strata ids are repeated across clusters
  weights = WTMEC2YR
)

summary(nhanes_des)
```

## Descriptive Analysis

Regress the continuous response variable, diastolic blood pressure (`bpxdi1_1`), on predictors of interest.

```{r}
da_race <-
  nhanes_des |> 
  filter(age18p == 1) %>%
  survey::svyglm(bpxdi1_1 ~ RIDRETH1, design = .)

da_age <-
  nhanes_des |> 
  filter(age18p == 1) %>%
  survey::svyglm(bpxdi1_1 ~ age, design = .)

da_age_c <-
  nhanes_des |> 
  filter(age18p == 1) |>
  mutate(agec = scale(age, scale = FALSE)) %>%
  survey::svyglm(bpxdi1_1 ~ agec, design = .)

da_gender <-
  nhanes_des |> 
  filter(age18p == 1) %>%
  survey::svyglm(bpxdi1_1 ~ riagendr, design = .)

da_marital <-
  nhanes_des |> 
  filter(age18p == 1) %>%
  survey::svyglm(bpxdi1_1 ~ marcat, design = .)

```

```{r}
#| code-fold: true
#| label: tbl-nhanes-da-bivariate

da_race_gt <-
  da_race |>
  gtsummary::tbl_regression(
    label = list(RIDRETH1 ~ "Race/ethnicity"),
    conf.int = FALSE
  )

da_age_c_gt <-
  da_age_c |>
  gtsummary::tbl_regression(
    label = list(agec ~ "Age (cent.)"),
    conf.int = FALSE
  )

da_gender_gt <-
  da_gender |>
  gtsummary::tbl_regression(
    label = list(riagendr ~ "Gender"),
    conf.int = FALSE
  )

da_marital_gt <-
  da_marital |>
  gtsummary::tbl_regression(
    label = list(marcat ~ "Marital status"),
    conf.int = FALSE
  )

gtsummary::tbl_stack(
  tbls = list(da_race_gt, da_age_c_gt, da_gender_gt, da_marital_gt)
) |>
  as_gt() |>
  gt::tab_caption("") |>
  gt::tab_header(
    title = "Initial Design-Based Bivariate Regression Analysis Results Assessing Potential  Predictors of Diastolic Blood Pressure for the 2011–2012 NHANES Adult Sample"
  ) |>
  gt::tab_options(heading.align = "left")
```


### Counts

How many U.S. adults have experience irregular heartbeats in their lifetime?

```{r}
nhanes_des |>
  survey_count(.by = irregular, vartype = c("se", "ci", "cv")) |>
  adorn_totals(, fill = NA,,, n) |>
  gt::gt() |>
  gt::fmt_number(n:n_upp, decimals = 0) |>
  gt::fmt_number(n_cv, decimals = 2) |>
  gt::cols_label(
    n = "Estimted Total Lifetime MDE",
    n_se = "Standard Error",
    n_low = "95% CI (low)",
    n_upp = "95% CI (upp)",
    n_cv = "CV"
  )
```

### Sums

What is the total number of participated at 18 or over by educational category? Sum `age18p`.

```{r}
nhanes_des |>
  summarize(
    .by = edcat, 
    Tot = survey_total(age18p, na.rm = TRUE, vartype = c("se", "ci", "var", "cv"))
  ) |>
  adorn_totals(, fill = NA,,, Tot, Tot) |>
  gt::gt() |>
  gt::fmt_number(Tot:Tot_var, decimals = 0) |>
  gt::fmt_number(Tot_cv, decimals = 2)
```

### Means and Proportions

What was the mean systolic blood pressure by marital status? Calculate mean(`BPXSY1`).

```{r}
nhanes_des |>
  summarize(
    .by = marcat,
    M = survey_mean(BPXSY1, na.rm = TRUE, vartype = c("se", "ci"))
  ) |>
  gt::gt() |>
  gt::fmt_number(decimals = 0)
```

What is the probability of holding each marital status? Calculate the proportion of `marcat`.

```{r}
nhanes_des |>
  summarize(
    .by = marcat,
    M = survey_prop()
  ) |>
  adorn_totals(, fill = NA,,, M) |>
  gt::gt() |>
  gt::fmt_number(M:M_se, decimals = 3)
```

### Quantiles

What was the IQR of systolic blood pressure by marital status? Calculate the IQR of `BPXSY1`.

```{r}
nhanes_des |>
  summarize(
    .by = marcat,
    Q = survey_quantile(BPXSY1, quantiles = c(.25, .5, .75))
  ) |>
  gt::gt() |>
  gt::fmt_number(ends_with("se"), decimals = 2)
```

### Ratios

Estimate the ratio of high-density total cholesterol.

```{r}
nhanes_des |> 
  filter(age >= 18) |>
  summarize(
    n = survey_total(),
    R = survey_ratio(lbdhdd, lbxtc, na.rm = TRUE, vartype = c("se", "ci"))
  ) |>
  gt::gt() |>
  gt::fmt_number(everything(), decimals = 3)
```



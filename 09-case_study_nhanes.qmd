# Case Study: NHANES

This case study follows the tutorial laid out in section 7.5 of @Heeringa2017. It uses the *National Health and Nutrition Examination Survey (NHANES)* to build a predictive model of diastolic blood pressure (DBP). The NHANES sample is a stratified cluster sample, weighted for unequal probabilities of selection, non-response, and post-stratification.

```{r setup, message=FALSE, warning=FALSE}
library(tidyverse)
library(scales)
library(janitor)
library(survey)
library(srvyr)
library(gtsummary)
```

## Executive summary

- Provide a brief overview of the survey including information related  to general study goals and year when annual survey was first implemented.
- Describe the purpose of this document.
- Provide a table of the sample size to be selected per business unit (i.e.,  respondent sample size inflated for ineligibility and nonresponse). 
- Discuss the contents of the remaining section of the report.  

## Sample design

**Description of the target population.** 

The target population was adults aged 18 and older residing in the 48 contiguous United States.

**Describe the sampling frame including the date and source database.** 

The sampling frame included households in the 48 contiguous United States. The survey was conducted between February 2001 and April 2003. The source database for the sampling frame was the Inter-university Consortium for Political and Social Research (ICPSR), which provided the necessary geographic and demographic information to ensure a nationally representative sample.

**Describe the type of sample and method of sample selection to be used.** 

The sampling strategy was a multi-stage clustered area probability sample. 
  - Stage 1 was to select primary sampling units. The entire country (48 contiguous states) was divided into primary sampling units (PSUs), composed of counties or groups of contiguous counties. A random sample of PSUs was selected.
  - Stage 2 was to select segments. The selected PSUs were subdivided into segments, usually census tracts or block groups. A random sample of segments was selected.
  - Stage 3 was to select households. A random sample of households was selected.
  - Stage 4 was to select respondents. A person was randomly selected from the household.

## Sample size and allocation

- Optimization requirements
  – Optimization details including constraints and budget.  
  – Detail the minimum domain sizes and mechanics used to determine  the sizes. 
- Optimization results  
  – Results: minimum respondent sample size per stratum  
  – Marginal sample sizes for key reporting domains  
  – Estimated precision achieved by optimization results  
- Inflation adjustments to allocation solution  
  – Nonresponse adjustments  
  – Adjustments for ineligible sample members  
- Final sample allocation  
  – Marginal sample sizes for key reporting domains  
- Sensitivity analysis  
  – Results from comparing deviations to allocation after introducing  changes to the optimization system  
  
## Data Preparation

Download [2015SEP2017.zip](https://www.umich.edu/~surveymethod/asda/Chapter%20Exercises%20Data%20Sets%20Stata%2015SEP2017.zip) from the *Applied Survey Data Analysis* book [web site](https://websites.umich.edu/~surveymethod/asda/) and unzip into the input/ directory of this project repo.
 
```{r}
nhanes_raw <- foreign::read.dta("input/nhanes1112_sub_10jun2016.dta")
```

Create labels for factor vars. Heeringa also identifies a data cleaning step, converting 0s to `NA`.

```{r}
nhanes <-
  nhanes_raw |>
  mutate(
    bpxdi1_1 = if_else(BPXDI1 == 0, NA_integer_, BPXDI1),
    RIDRETH1 = factor(RIDRETH1, labels = c(
      "Mexican-American", "Other Hispanic", "Non-Hispanic White",
      "Non-Hispanic Black", "Other race")),
    riagendr = factor(riagendr, labels = c("Male", "Female")),
    marcat = factor(marcat, labels = c(
      "Married", "Previously married", "Never married"))
  )
```

Create a survey design object for analysis.

```{r}
nhanes_des <- as_survey_design(
  nhanes,
  ids = sdmvpsu,  # primary sampling unit (cluster)
  strata = sdmvstra,  # sampling stratum
  nest = TRUE,  # strata ids are repeated across clusters
  weights = WTMEC2YR
)

summary(nhanes_des)
```

## Descriptive Analysis

Regress the continuous response variable, diastolic blood pressure (`bpxdi1_1`), on five predictors of interest: race/ethnicity (`RIDRETH1`), age (`agec`), gender (`riagendr`), and marriage status (`marcat`).

```{r}
nhanes_des |>
  filter(age18p == 1) |>
  mutate(agec = scale(age, scale = FALSE)) |>
  select(bpxdi1_1, RIDRETH1, agec, riagendr, marcat) |>
  tbl_uvregression(
    y = bpxdi1_1,
    method = survey::svyglm,
    label = list(
      RIDRETH1 ~ "Race/ethnicity", 
      agec ~ "Age (cent.)", 
      riagendr ~ "Gender",
      marcat ~ "Marital status"
    )
  ) |>
  as_gt() |>
  gt::tab_caption(".") |>
  gt::tab_header(
    title = "Initial Design-Based Bivariate Regression Analysis Results ",
    subtitle = "Assessing Potential Predictors of Diastolic Blood Pressure for the 2011–2012 NHANES Adult Sample"
  ) |>
  gt::tab_options(heading.align = "left")
```

The design-based t-tests suggest that race/ethnicity, age, and gender have  potentially significant relationships with DBP, while marital status  does not appear to be related. Non-Hispanic whites, non-Hispanic blacks, older adults, and males appear to have the highest DBPs at first glance. Include the first three predictors in an initial model. 

## Analysis

Fit a regression model with the variables of interest.

```{r}
nhanes_fit <- 
  nhanes_des |>
  filter(age18p == 1) |>
  mutate(agec = scale(age, scale = FALSE)) %>%
  svyglm(
    bpxdi1_1 ~ RIDRETH1 + agec + riagendr,
    design = .
  )

nhanes_fit |>
  gtsummary::tbl_regression(
    label = list(
      RIDRETH1 ~ "Race/ethnicity", 
      agec ~ "Age (cent.)", 
      riagendr ~ "Gender"
    )
  ) |>
  gtsummary::add_glance_source_note() |>
  as_gt() |>
  gt::tab_caption(".") |>
  gt::tab_header(
    title = "Design-Based Estimates of the Regression Parameters in the Initial “Main”  Model for Diastolic Blood Pressure",
    subtitle = "Linearized Standard Errors for the Estimates, Design-Adjusted Test Statistics and Confidence Intervals for the Parameters, and Design Effects for the Parameter Estimates."
  ) |>
  gt::tab_options(heading.align = "left")
```

The degrees of freedom for the t-statistics are the number of ultimate clusters (31) minus the number of strata (14).

```{r}
par(mfrow = c(2, 2))
plot(nhanes_fit, labels.id = NULL)
```

What is the probability of holding each marital status? Calculate the proportion of `marcat`.

```{r}
nhanes_des |>
  summarize(
    .by = marcat,
    M = survey_prop()
  ) |>
  adorn_totals(, fill = NA,,, M) |>
  gt::gt() |>
  gt::fmt_number(M:M_se, decimals = 3)
```

### Quantiles

What was the IQR of systolic blood pressure by marital status? Calculate the IQR of `BPXSY1`.

```{r}
nhanes_des |>
  summarize(
    .by = marcat,
    Q = survey_quantile(BPXSY1, quantiles = c(.25, .5, .75))
  ) |>
  gt::gt() |>
  gt::fmt_number(ends_with("se"), decimals = 2)
```

### Ratios

Estimate the ratio of high-density total cholesterol.

```{r}
nhanes_des |> 
  filter(age >= 18) |>
  summarize(
    n = survey_total(),
    R = survey_ratio(lbdhdd, lbxtc, na.rm = TRUE, vartype = c("se", "ci"))
  ) |>
  gt::gt() |>
  gt::fmt_number(everything(), decimals = 3)
```



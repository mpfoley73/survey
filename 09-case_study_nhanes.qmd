# Case Study: NHANES

This case study follows the tutorial laid out in section 7.5 of @Heeringa2017. It uses the *National Health and Nutrition Examination Survey (NHANES)* to build a predictive model of diastolic blood pressure (DBP). The NHANES sample is a stratified cluster sample, weighted for unequal probabilities of selection, non-response, and post-stratification.

```{r setup, message=FALSE, warning=FALSE}
library(tidyverse)
library(scales)
library(janitor)
library(survey)
library(srvyr)
library(gtsummary)
library(broom)
library(ggeffects)
```

## Executive summary

- Provide a brief overview of the survey including information related  to general study goals and year when annual survey was first implemented.
- Describe the purpose of this document.
- Provide a table of the sample size to be selected per business unit (i.e.,  respondent sample size inflated for ineligibility and nonresponse). 
- Discuss the contents of the remaining section of the report.  

## Sample design

**Description of the target population.** 

The target population was adults aged 18 and older residing in the 48 contiguous United States.

**Describe the sampling frame including the date and source database.** 

The sampling frame included households in the 48 contiguous United States. The survey was conducted between February 2001 and April 2003. The source database for the sampling frame was the Inter-university Consortium for Political and Social Research (ICPSR), which provided the necessary geographic and demographic information to ensure a nationally representative sample.

**Describe the type of sample and method of sample selection to be used.** 

The sampling strategy was a multi-stage clustered area probability sample. 
  - Stage 1 was to select primary sampling units. The entire country (48 contiguous states) was divided into primary sampling units (PSUs), composed of counties or groups of contiguous counties. A random sample of PSUs was selected.
  - Stage 2 was to select segments. The selected PSUs were subdivided into segments, usually census tracts or block groups. A random sample of segments was selected.
  - Stage 3 was to select households. A random sample of households was selected.
  - Stage 4 was to select respondents. A person was randomly selected from the household.

## Sample size and allocation

- Optimization requirements
  – Optimization details including constraints and budget.  
  – Detail the minimum domain sizes and mechanics used to determine  the sizes. 
- Optimization results  
  – Results: minimum respondent sample size per stratum  
  – Marginal sample sizes for key reporting domains  
  – Estimated precision achieved by optimization results  
- Inflation adjustments to allocation solution  
  – Nonresponse adjustments  
  – Adjustments for ineligible sample members  
- Final sample allocation  
  – Marginal sample sizes for key reporting domains  
- Sensitivity analysis  
  – Results from comparing deviations to allocation after introducing  changes to the optimization system  
  
## Data Preparation

Download [2015SEP2017.zip](https://www.umich.edu/~surveymethod/asda/Chapter%20Exercises%20Data%20Sets%20Stata%2015SEP2017.zip) from the *Applied Survey Data Analysis* book [web site](https://websites.umich.edu/~surveymethod/asda/) and unzip into the input/ directory of this project repo.
 
```{r}
nhanes_raw <- foreign::read.dta("input/nhanes1112_sub_10jun2016.dta")
```

Create labels for factor vars. Heeringa also identifies a data cleaning step, converting 0s to `NA`.

```{r}
nhanes <-
  nhanes_raw |>
  mutate(
    bpxdi1_1 = if_else(BPXDI1 == 0, NA_integer_, BPXDI1),
    RIDRETH1 = factor(RIDRETH1, labels = c(
      "Mexican-American", "Other Hispanic", "Non-Hispanic White",
      "Non-Hispanic Black", "Other race")),
    riagendr = factor(riagendr, labels = c("Male", "Female")),
    marcat = factor(marcat, labels = c(
      "Married", "Previously married", "Never married"))
  )
```

Create a survey design object for analysis.

```{r}
nhanes_des <- as_survey_design(
  nhanes,
  ids = sdmvpsu,  # primary sampling unit (cluster)
  strata = sdmvstra,  # sampling stratum
  nest = TRUE,  # strata ids are repeated across clusters
  weights = WTMEC2YR
)

summary(nhanes_des)
```

## Descriptive Analysis

Regress the continuous response variable, diastolic blood pressure (`bpxdi1_1`), on five predictors of interest: race/ethnicity (`RIDRETH1`), age (`agec`), gender (`riagendr`), and marriage status (`marcat`).

```{r}
nhanes_des |>
  filter(age18p == 1) |>
  mutate(agec = scale(age, scale = FALSE)) |>
  select(bpxdi1_1, RIDRETH1, agec, riagendr, marcat) |>
  tbl_uvregression(
    y = bpxdi1_1,
    method = survey::svyglm,
    label = list(
      RIDRETH1 ~ "Race/ethnicity", 
      agec ~ "Age (cent.)", 
      riagendr ~ "Gender",
      marcat ~ "Marital status"
    )
  ) |>
  as_gt() |>
  gt::tab_caption(".") |>
  gt::tab_header(
    title = "Initial Design-Based Bivariate Regression Analysis Results ",
    subtitle = "Assessing Potential Predictors of Diastolic Blood Pressure for the 2011–2012 NHANES Adult Sample"
  ) |>
  gt::tab_options(heading.align = "left")
```

The design-based t-tests suggest that race/ethnicity, age, and gender have  potentially significant relationships with DBP, while marital status  does not appear to be related. Non-Hispanic whites, non-Hispanic blacks, older adults, and males appear to have the highest DBPs at first glance. Include the first three predictors in an initial model. 

## Analysis

Fit an initial regression model with the variables of interest.

```{r}
fit_1 <- 
  nhanes_des |>
  filter(age18p == 1) |>
  mutate(agec = scale(age, scale = FALSE)) %>%
  svyglm(
    bpxdi1_1 ~ RIDRETH1 + agec + riagendr,
    design = .
  )

fit_1 |>
  gtsummary::tbl_regression(
    label = list(
      RIDRETH1 ~ "Race/ethnicity", 
      agec ~ "Age (cent.)", 
      riagendr ~ "Gender"
    ),
    intercept = TRUE
  ) |>
  gtsummary::add_glance_source_note() |>
  gtsummary::add_n() |>
  gtsummary::bold_p() |>
  as_gt() |>
  gt::tab_caption(".") |>
  gt::tab_header(
    title = "Initial Model for Diastolic Blood Pressure",
    subtitle = "Design-Adjusted Test Statistics and Confidence Intervals for the Parameters, and Design Effects for the Parameter Estimates."
  ) |>
  gt::tab_options(heading.align = "left")
```

The degrees of freedom for the t-statistics are the number of ultimate clusters (31) minus the number of strata (14).

Plot residuals against the predictor variables. The `augment()` function has not been specifically written for `svyglm` objects, so you need to make a couple adjustments.

```{r}
preds_1 <-
  augment(fit_1) |>
  mutate(
    .se.fit = sqrt(attr(.fitted, "var")),
    .fitted = as.numeric(.fitted)
  )
```

Start with the centered age, `agec`. This plot has a curvilinear pattern suggesting a quadratic relationship. Add a squared term and re-plot the residuals.

```{r}
fit_2 <- 
  nhanes_des |>
  filter(age18p == 1) |>
  mutate(agec = scale(age, scale = FALSE)) %>%
  svyglm(
    bpxdi1_1 ~ RIDRETH1 + agec + I(agec^2) + riagendr,
    design = .
  )

preds_2 <- 
  augment(fit_2) |>
  mutate(
    .se.fit = sqrt(attr(.fitted, "var")),
    .fitted = as.numeric(.fitted)
  )

bind_rows(
  Original = preds_1,
  `With squared term` = preds_2,
  .id = "mdl"
) |>
  ggplot(aes(y = .resid, x = agec)) +
  geom_point() +
  facet_wrap(vars(mdl)) +
  labs(title = "Residuals vs centered age before and after addition of squared age variable.")
```

It _does_ appear better. The AIC and BIC decreased, meaning the second model is more efficient.

```{r}
bind_rows(
  fit_1 = glance(fit_1),
  fit_2 = glance(fit_2),
  .id = "Model Fit"
) |>
  gt::gt()
```

Consider interactions with each of the demographic factor variables, one at a time - is the relationship between age and DBP moderated by these variables? Add the interaction with ethnicity to the model, then perform a Wald test of the null hypothesis that all eight parameters are simultaneously equal to zero.

```{r}
fit_3 <- 
  nhanes_des |>
  filter(age18p == 1) |>
  mutate(agec = scale(age, scale = FALSE)) %>%
  svyglm(
    bpxdi1_1 ~ RIDRETH1*agec + RIDRETH1*I(agec^2) + riagendr,
    design = .
  )

fit_3 |> broom::tidy()

regTermTest(fit_3, ~ RIDRETH1:agec + RIDRETH1:I(agec^2))
```

None of the interaction estimators have a *p*-value < .05, and the Wald test fails to reject the null hypothesis. How about interacting with gender? This time the interactions are significant and the Wald test rejects the null hypothesis.

```{r}
fit_4 <- 
  nhanes_des |>
  filter(age18p == 1) |>
  mutate(agec = scale(age, scale = FALSE)) %>%
  svyglm(
    bpxdi1_1 ~ RIDRETH1 + riagendr*agec + riagendr*I(agec^2),
    design = .
  )

fit_4 |> broom::tidy()

regTermTest(fit_4, ~ riagendr:agec + riagendr:I(agec^2))
```

Plot marginal predicted values from DBP to assess variability in the relationship between age and DBP depending on race/ethnicity and gender.

```{r}
fit_4 |>
  ggpredict(terms = "RIDRETH1") |>
  ggplot(aes(x = x, y = predicted)) +
  geom_point()

# library(emmeans)
# emmeans(fit_4, ~ RIDRETH1)
```



```{r}
par(mfrow = c(2, 2))
plot(fit_2, labels.id = NULL)

```


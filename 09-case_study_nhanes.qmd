# Case Study: NHANES

This case study follows the tutorial laid out in section 7.5 of @Heeringa2017. It uses the *National Health and Nutrition Examination Survey (NHANES)* to build a predictive model of diastolic blood pressure (DBP). The NHANES sample is a stratified cluster sample, weighted for unequal probabilities of selection, non-response, and post-stratification.

```{r setup, message=FALSE, warning=FALSE}
library(tidyverse)
library(scales)
library(janitor)
library(glue)
library(survey)
library(srvyr)
library(gtsummary)
library(broom)
library(ggeffects)
library(svydiags)
```

## Data Preparation

Download [2015SEP2017.zip](https://www.umich.edu/~surveymethod/asda/Chapter%20Exercises%20Data%20Sets%20Stata%2015SEP2017.zip) from the *Applied Survey Data Analysis* book [web site](https://websites.umich.edu/~surveymethod/asda/) and unzip into the input/ directory of this project repo.
 
```{r}
nhanes_raw <- foreign::read.dta("input/nhanes1112_sub_10jun2016.dta")
```

Create labels for factor vars. Heeringa also identifies a data cleaning step, converting 0s to `NA`.

```{r}
nhanes <-
  nhanes_raw |>
  mutate(
    bpxdi1_1 = if_else(BPXDI1 == 0, NA_integer_, BPXDI1),
    RIDRETH1 = factor(RIDRETH1, labels = c(
      "Mexican-American", "Other Hispanic", "Non-Hispanic White",
      "Non-Hispanic Black", "Other race")),
    riagendr = factor(riagendr, labels = c("Male", "Female")),
    marcat = factor(marcat, labels = c(
      "Married", "Previously married", "Never married"))
  )
```

Create a survey design object for analysis. Use it to create a new variable, centered age, `agec`.

```{r}
nhanes_des_0 <- as_survey_design(
  nhanes,
  ids = sdmvpsu,  # primary sampling unit (cluster)
  strata = sdmvstra,  # sampling stratum
  nest = TRUE,  # strata ids are repeated across clusters
  weights = WTMEC2YR
)

weighted_mean_age <-
  nhanes_des_0 |>
  filter(age >= 18) |>
  summarize(M = survey_mean(age)) |>
  pull(M)

nhanes_des <- nhanes_des_0 |> mutate(agec = age - weighted_mean_age)

summary(nhanes_des)
```

## Descriptive Analysis

Regress the continuous response variable, diastolic blood pressure (`bpxdi1_1`), on five predictors of interest: race/ethnicity (`RIDRETH1`), centered-age (`agec`), gender (`riagendr`), and marriage status (`marcat`).

```{r}
#| code-fold: true

nhanes_des |>
  tbl_uvregression(
    y = bpxdi1_1,
    method = survey::svyglm,
    method.args = list(subset = (age18p == 1)),
    include = c(RIDRETH1, agec, riagendr, marcat),
    pvalue_fun = label_style_pvalue(digits = 2),
    label = list(
      RIDRETH1 ~ "Race/ethnicity", 
      agec ~ "Age (cent.)", 
      riagendr ~ "Gender",
      marcat ~ "Marital status"
    )
  ) |>
  # add_global_p(anova_fun = tidy_wald_test) |>
  as_gt() |>
  gt::tab_caption(".") |>
  gt::tab_header(
    title = "Initial Design-Based Bivariate Regression Analysis Results ",
    subtitle = glue("Assessing Potential Predictors of Diastolic Blood Pressure ",
                    "for the 2011â€“2012 NHANES Adult Sample")
  ) |>
  gt::tab_options(heading.align = "left") 
```

The design-based t-tests suggest that race/ethnicity, age, and gender have  potentially significant relationships with DBP, while marital status  does not appear to be related. Non-Hispanic whites, non-Hispanic blacks, older adults, and males appear to have the highest DBPs at first glance. Include the first three predictors in an initial model. 

## Analysis

### Model Fitting

Fit an initial regression model with the variables of interest. Notice how the dataset is filtered _inside_ the model with `subset`.

```{r}
fit_1 <- 
  nhanes_des |>
  mutate(agec = scale(age, scale = FALSE)) %>%
  svyglm(
    bpxdi1_1 ~ RIDRETH1 + agec + riagendr,
    design = .,
    subset = (age18p == 1)
  )
```

```{r}
#| code-fold: true
fit_1 |>
  gtsummary::tbl_regression(
    label = list(
      RIDRETH1 ~ "Race/ethnicity", 
      agec ~ "Age (cent.)", 
      riagendr ~ "Gender"
    ),
    intercept = TRUE
  ) |>
  gtsummary::add_glance_source_note() |>
  gtsummary::add_n(location = "level") |>
  gtsummary::bold_p() |>
  as_gt() |>
  gt::tab_caption(".") |>
  gt::tab_header(
    title = "Initial Model for Diastolic Blood Pressure",
    subtitle = glue("Design-Adjusted Test Statistics and Confidence Intervals ",
                    "for the Parameters, and Design Effects for the Parameter ",
                    "Estimates.")
  ) |>
  gt::tab_options(heading.align = "left")
```

The *t* statistics degrees of freedom equal the number of ultimate clusters (31) minus the number of strata (14).

Plot residuals against the predictor variables. The `augment()` function has not been specifically written for `svyglm` objects, so you need to make a couple adjustments.

```{r}
preds_1 <-
  augment(fit_1) |>
  mutate(
    .se.fit = sqrt(attr(.fitted, "var")),
    .fitted = as.numeric(.fitted)
  )
```

Start with the centered age, `agec`. This plot has a curvilinear pattern suggesting a quadratic relationship. Add a squared term and re-plot the residuals.

```{r}
fit_2 <- svyglm(
  bpxdi1_1 ~ RIDRETH1 + agec + I(agec^2) + riagendr,
  design = nhanes_des,
  subset = (age18p == 1)
)

preds_2 <- 
  augment(fit_2) |>
  mutate(
    .se.fit = sqrt(attr(.fitted, "var")),
    .fitted = as.numeric(.fitted)
  )
```

```{r}
#| code-fold: true

bind_rows(
  Original = preds_1,
  `With squared term` = preds_2,
  .id = "mdl"
) |>
  ggplot(aes(y = .resid, x = agec)) +
  geom_point() +
  facet_wrap(vars(mdl)) +
  labs(title = glue("Residuals vs centered age before and after addition of ",
                    "squared age variable."))
```

It _does_ appear better. The AIC and BIC also decreased, meaning the second model is more efficient.

```{r}
#| code-fold: true

bind_rows(
  fit_1 = glance(fit_1),
  fit_2 = glance(fit_2),
  .id = "Model Fit"
) |>
  gt::gt()
```

Add interactions between `agec` and each of the demographic factor variables, one at a time, to test whether they moderate the relationship between age and DBP. Start with race/ethnicity, and perform a Wald test of the null hypothesis that all eight parameters are simultaneously equal to zero.

```{r}
fit_3 <- svyglm(
  bpxdi1_1 ~ RIDRETH1*agec + RIDRETH1*I(agec^2) + riagendr,
  design = nhanes_des,
  subset = (age18p == 1)
)

regTermTest(fit_3, ~ RIDRETH1:agec + RIDRETH1:I(agec^2))
```

None of the interaction estimators have a *p*-value < .05, and the Wald test fails to reject the null hypothesis. How about interacting with gender? This time the interactions are significant and the Wald test rejects the null hypothesis.

```{r}
fit_4 <- svyglm(
  bpxdi1_1 ~ RIDRETH1 + riagendr*agec + riagendr*I(agec^2),
  design = nhanes_des,
  subset = (age18p == 1)
)

regTermTest(fit_4, ~ riagendr:agec + riagendr:I(agec^2))
```

Plot marginal predicted values from DBP to assess variability in the relationship between age and DBP depending on race/ethnicity and gender. African Americans have a higher acceleration in DBP until middle age, then the gap decreases. 

```{r}
#| code-fold: true
bind_rows(
  `Race/Ethnicity` = fit_4 |>
    predict_response(terms = c("agec [-30:30 by=5]", "RIDRETH1")) |>
    as_tibble(),
  Gender = fit_4 |>
    predict_response(terms = c("agec [-30:30 by=5]", "riagendr")) |>
    as_tibble(),
  .id = "Covar"
) |>
  mutate(group = fct_relevel(group, c("Female", "Male"), after = 0)) |>
  ggplot(aes(x = x, y = predicted, color = group)) + 
  geom_errorbar(aes(ymin = conf.low, ymax = conf.high), width = 0.8) +
  geom_point() +
  geom_line() +
  labs(
    x = "Centered Age", y = "Marginal predicted DBP", color = NULL,
    title = "Marginal predicted values from regression model.",
    subtitle = "Interaction of age and race/ethnicity"
  ) +
  facet_wrap(vars(Covar)) +
  theme(legend.position = "top", legend.justification = "left")
```

### Model Diagnostics

The diagnostic plots

```{r}
par(mfrow = c(2, 2))
plot(fit_4, labels.id = NULL)
```

```{r}
cooks_d4 <- svyCooksD(fit_4, stvar = "sdmvstra", clvar = "sdmvpsu", doplot = TRUE)
```


